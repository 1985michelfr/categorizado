<!DOCTYPE html>
<html>
  <head>
    <title>Relatório de Gastos</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
      .transacoes-row {
        display: none;
        background-color: #f8f9fa;
      }
      .categoria-row {
        cursor: pointer;
      }
      .categoria-row:hover {
        background-color: #f1f1f1;
      }
      .competencias-list {
        margin-bottom: 2rem;
      }
      .competencia-link {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        text-decoration: none;
      }
      .competencia-link:hover {
        background-color: #f8f9fa;
      }
      .competencia-link.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container mt-5">
      <h2>
        Relatório de Gastos {% if mes and ano %}- {{ mes }}/{{ ano }}{% endif %}
      </h2>

      <div class="competencias-list">
        <h4>Competências Disponíveis:</h4>
        <div>
          {% for comp in competencias %}
          <a
            href="{{ url_for('relatorio', mes=comp.mes, ano=comp.ano) }}"
            class="competencia-link {% if mes and ano and mes|int == comp.mes|int and ano|int == comp.ano|int %}active{% endif %}"
          >
            {{ comp.mes }}/{{ comp.ano }}
          </a>
          {% endfor %}
        </div>
      </div>

      {% if not mes or not ano %}
      <div class="alert alert-info">
        Selecione uma competência acima para visualizar o relatório.
      </div>
      {% endif %}

      <form method="get" class="mb-4">
        <div class="row g-3 align-items-center">
          <div class="col-auto">
            <label for="mes" class="form-label">Mês:</label>
            <input
              type="number"
              class="form-control"
              name="mes"
              id="mes"
              min="1"
              max="12"
              value="{{ mes }}"
            />
          </div>
          <div class="col-auto">
            <label for="ano" class="form-label">Ano:</label>
            <input
              type="number"
              class="form-control"
              name="ano"
              id="ano"
              value="{{ ano }}"
            />
          </div>
          <div class="col-auto">
            <label class="form-label">&nbsp;</label>
            <button type="submit" class="form-control btn btn-primary">
              Filtrar
            </button>
          </div>
        </div>
      </form>

      {% if gastos %}
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% for gasto in gastos %}
          <tr
            class="categoria-row"
            onclick="toggleTransacoes('categoria-{{ gasto.id }}')"
          >
            <td>
              <a
                href="{{ url_for('detalhes_categoria', categoria_id=gasto.id, mes=mes, ano=ano) }}"
              >
                {{ gasto.nome }}
              </a>
            </td>
            <td>R$ {{ "%.2f"|format(gasto.total) }}</td>
          </tr>
          <tr id="categoria-{{ gasto.id }}" class="transacoes-row">
            <td colspan="2">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Estabelecimento</th>
                    <th>Valor</th>
                  </tr>
                </thead>
                <tbody>
                  {% if gasto.id in transacoes_por_categoria %} {% for transacao
                  in transacoes_por_categoria[gasto.id] %}
                  <tr>
                    <td>{{ transacao.data.strftime('%d/%m/%Y') }}</td>
                    <td>{{ transacao.estabelecimento }}</td>
                    <td>
                      R$ {{ "%.2f"|format(transacao.valor) }}
                      <button 
                        class="btn btn-link btn-sm float-end"
                        data-bs-toggle="modal"
                        data-bs-target="#modalEditarCategoria-{{ transacao.id }}"
                      >
                        <i class="bi bi-pencil text-primary"></i>
                      </button>
                    </td>
                  </tr>
                  {% endfor %} {% endif %}
                </tbody>
              </table>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="row mt-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h4>Distribuição de Gastos por Categoria</h4>
            </div>
            <div class="card-body">
              <canvas id="graficoCategoria"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h4>Evolução dos Gastos por Competência</h4>
            </div>
            <div class="card-body">
              <canvas id="graficoEvolucao"></canvas>
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <p>Nenhum gasto encontrado para o período selecionado.</p>
      {% endif %}

      <a href="{{ url_for('index') }}" class="btn btn-primary">Voltar</a>
    </div>

    {% if gastos %}
      {% for gasto in gastos %}
        {% if gasto.id in transacoes_por_categoria %}
          {% for transacao in transacoes_por_categoria[gasto.id] %}
          <!-- Modal para cada transação -->
          <div class="modal fade" id="modalEditarCategoria-{{ transacao.id }}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Editar Categoria</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <p>
                    <strong>Data:</strong> {{ transacao.data.strftime('%d/%m/%Y') }}<br>
                    <strong>Estabelecimento:</strong> {{ transacao.estabelecimento }}<br>
                    <strong>Valor:</strong> R$ {{ "%.2f"|format(transacao.valor) }}
                  </p>
                  <form action="{{ url_for('atualizar_categoria_transacao') }}" method="POST">
                    <input type="hidden" name="transacao_id" value="{{ transacao.id }}">
                    <input type="hidden" name="mes" value="{{ mes }}">
                    <input type="hidden" name="ano" value="{{ ano }}">
                    <div class="mb-3">
                      <label class="form-label">Nova Categoria:</label>
                      <select name="categoria_id" class="form-select">
                        {% for cat in categorias %}
                        <option value="{{ cat.id }}" {% if cat.id == gasto.id %}selected{% endif %}>
                          {{ cat.nome }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="text-end">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <script>
      function toggleTransacoes(categoriaId) {
        const row = document.getElementById(categoriaId);
        if (row.style.display === "none" || row.style.display === "") {
          row.style.display = "table-row";
        } else {
          row.style.display = "none";
        }
      }

      {% if gastos %}
      // Gráfico de Pizza - Distribuição por Categoria
      const ctxPizza = document.getElementById('graficoCategoria').getContext('2d');
      new Chart(ctxPizza, {
        type: 'pie',
        data: {
          labels: {{ dados_grafico_pizza.labels | tojson }},
          datasets: [{
            data: {{ dados_grafico_pizza.valores | tojson }},
            backgroundColor: [
              '#FF6384',
              '#36A2EB',
              '#FFCE56',
              '#4BC0C0',
              '#9966FF',
              '#FF9F40',
              '#FF6384',
              '#36A2EB',
              '#FFCE56'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
            },
            title: {
              display: true,
              text: 'Distribuição de Gastos por Categoria'
            }
          }
        }
      });

      // Gráfico de Linha - Evolução dos Gastos
      const ctxLinha = document.getElementById('graficoEvolucao').getContext('2d');
      new Chart(ctxLinha, {
        type: 'line',
        data: {
          labels: [
            {% for comp in gastos_por_competencia %}
              '{{ comp.mes }}/{{ comp.ano }}',
            {% endfor %}
          ],
          datasets: [{
            label: 'Total de Gastos',
            data: [
              {% for comp in gastos_por_competencia %}
                {{ comp.total }},
              {% endfor %}
            ],
            borderColor: '#36A2EB',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Evolução dos Gastos por Competência'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'R$ ' + value.toFixed(2);
                }
              }
            }
          }
        }
      });
      {% endif %}
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
